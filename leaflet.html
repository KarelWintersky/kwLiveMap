<!DOCTYPE html>
<html>
<head>
    <title>kwRPG Map Engine :: Trollfjorden (leaflet)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- styles -->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" href="css/colorbox.css">
    <!-- core js -->
    <script type="text/javascript" src="js/html5shiv.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.colorbox.js"></script>
    <script type="text/javascript" src="js/jquery.tiny-draggable.js"></script>
    <!-- custom js -->
    <script type="text/javascript" src="js/kwrpgmaps.core.js"></script>
    <!-- map js -->
    <script type="text/javascript" src="js/map.trollfjorden.js"></script>
    <!-- leaflet -->
    <link rel="stylesheet" href="css/leaflet.css" />
    <script type="text/javascript" src="js/leaflet.js"></script>
    <link rel="stylesheet" href="js/leaflet/L.Control.MousePosition.css">
    <script type="text/javascript" src="js/leaflet/L.Control.MousePosition.js"></script>
    <script type="text/javascript" src="js/leaflet/singleclick.js"></script>

    <!-- internal js -->
    <script type="text/javascript">
        var hex_loaded_content = '';
        var hex_current_coords = '';

        $(document).ready(function(){
            $.ajaxSetup({cache: false});
            /* init leaflet */
            var leaflet_config = {
                w:          4192,
                h:          3306,
                url:        'images/maps/trollfjorden_xl.png',
                ief:        4, // image enlarge factor
                min_zoom:   1,
                max_zoom:   5,
                curr_zoom:  2.5
            };

            var map = L.map('leafletmap', {
                minZoom:    leaflet_config.min_zoom,
                maxZoom:    leaflet_config.max_zoom,
                zoom:       leaflet_config.curr_zoom,
                center:     [-100, 120],
                crs:        L.CRS.Simple
            });

            // calculate the edges of the image, in coordinate space
            var southWest = map.unproject([0, leaflet_config.h], map.getMaxZoom()-1);
            var northEast = map.unproject([leaflet_config.w, 0], map.getMaxZoom()-1);
            var bounds = new L.LatLngBounds(southWest, northEast);

            // add the image overlay, so that it covers the entire map
            L.imageOverlay(leaflet_config.url, bounds).addTo(map);

            // tell leaflet that the map is exactly as big as the image
            map.setMaxBounds(bounds);
            // set view position
            // map.setView(new L.LatLng(-100, 200), 2);

            L.control.mousePosition({
                numDigits   : 2,
                lngFirst    :   true,
                latFormatter: function(data){
                    return -Math.floor(data);
                },
                lngFormatter: function(data){
                    return Math.floor(data);
                }
            }).addTo(map);

            // hook mouseclick
            map.on('singleclick',function ( e ) {
                var leaflet_coords = {
                    x:      Math.floor(e.latlng.lng),
                    y:     -Math.floor(e.latlng.lat)
                };



                var pow_factor = Math.pow(2, leaflet_config.max_zoom - leaflet_config.ief + 1);
                var mx = leaflet_coords.x * pow_factor;
                var my = leaflet_coords.y * pow_factor;

                // load hex info

                var hex = getHex(mx, my);
                hex_current_coords = pad(hex.col, 2) + pad(hex.row, 2);
                if (loadHexInfo(hex, "#colorboxed-view-content")) {
                    var str_title =
                            '&nbsp;<img src="images/cursor_drag_arrow_2.png" align="bottom" width="16" width="16">&nbsp;&nbsp;'
                                    + 'Координаты: </span>'
                                    + hex_current_coords
                                    + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                                    + '<button id="actor-edit"> Редактировать </button>';

                    $.colorbox({
                        inline: true,
                        href: '#colorboxed-view',
                        width: 800,
                        height: 600,
                        title: str_title
                    });
                }
            } );

            $(document).on('click', '#actor-edit', function(){
                document.location.href = 'edit.php?id='+ hex_current_coords;
            });

            $("#colorbox").tinyDraggable({
                handle: '#cboxTitle',
                exclude: 'button'
            });
        });
    </script>
</head>
<body>
<h3>Trollfjoren live map</h3>
Нажмите на <strike>кексик</strike> гексик карты и... =^.^=<br><br>
<div id="leafletmap"></div>

<div style="display:none">
    <div id="colorboxed-view" style="padding:10px; background:#fff;">
        <div id="colorboxed-view-content"></div>
    </div>
</div>


</body>
</html>
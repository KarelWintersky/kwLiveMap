<!DOCTYPE html>
<html>
<head>
    <title>My canvas test</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/kw_lme.core.js"></script>
    <script>
        function random(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        var map_object = {
            // параметры изображения
            image           :   'images/maps/trollfjorden_l.png',
            border_size     :   1,
            // ноль координат
            x0              :   0,
            y0              :   0,
            // параметры гексагональной сетки
            grid_type       :   'hex:x_oriented',
            maxcol          :   23,
            maxrow          :   16,
            hexgrid_size    :   29.82,

            // настройки отрисовки
            areas_hidden    :   0.2,
            areas_revealed  :   0
        }


        var     edge = 29.82,
                shift = edge/ 2,
                h = 51.62,
                hh = h / 2,
                x0 = 0,
                y0 = 0,
                map_object = {
                    hexgrid_size : edge
                };

        $(document).ready(function(){
            var
                canvas = document.getElementById('mapcanvas'),
                ctx = canvas.getContext('2d');

            /**
             * отлавливаем клик по канвасу
             */

            $("#mapcanvas").on('click', function(event){
                var coords = getCanvasXYPos(this, event);
                console.log(coords);

                var hexcoords = getHex(coords.x, coords.y);
                alert(hexcoords.col + ':' + hexcoords.row);
            });

            var revealedAreas = loadRevealedAreas();
            console.log(revealedAreas.toSource());

            /* var zkey, maxcol=23, maxrow = 16;
            for(var col=1; col <= maxcol; col++) {
                for (var row=1; row <= maxrow; row++) {
                    zkey = 'z'+pad(col,2)+pad(row,2);
                    if (zkey in revealedAreas) continue;
                    if (row == 16 && (col % 2) == 0) continue;
                    drawHex(ctx, col, row, 0.2);
                }
            } */

            drawFogOfWar(ctx, revealedAreas);

        });

    </script>
    <style type="text/css">
        .themap{position:absolute;z-index:1;}

        #map-container {
            display:inline-block;
            width:1048px;
            height:827px;
            margin: 0 auto;
            position:relative;
        }

        #mapcanvas {
            position:relative;
            z-index:20;
        }
        .themap {
            opacity: 0.8;
        }
        area:hover {border: 1px solid red}
    </style>

</head>

<body>

<div id="map-container">
    <img class='themap' src="images/maps/trollfjorden_l.png" border=""/>
    <canvas id="mapcanvas" width="1048" height="827"></canvas>
</div>


</body>
</html>
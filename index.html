<!DOCTYPE html>
<html>
<head>
    <title>kwRPG Map Engine :: Trollfjorden</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- styles -->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" href="css/colorbox.css">
    <!-- core js -->
    <link href='https://fonts.googleapis.com/css?family=Didact+Gothic&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="js/html5shiv.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.colorbox.js"></script>
    <script type="text/javascript" src="js/jquery.tiny-draggable.js"></script>
    <!-- custom js -->
    <script type="text/javascript" src="js/kw_lme.core.js"></script>
    <!-- internal js -->
    <script type="text/javascript">
        var map_object = {
            // параметры изображения
            image           :   'images/maps/trollfjorden_l.png',
            border_size     :   1,
            // ноль координат
            x0              :   0,
            y0              :   0,
            // параметры гексагональной сетки
            grid_type       :   'hex:x_oriented',
            max_col         :   23,
            max_row         :   16,
            // заполняются отдельно, так как вычисляются
            edge            :   29.82, // hexgrid_size
            shift           :   null,
            height          :   51.62,
            halfheight      :   null,

            // настройки отрисовки
            areas_hidden    :   0.2,
            areas_revealed  :   0
        }

        var hex_loaded_content = '';
        var hex_current_coords = '';




        $(document).ready(function(){
            initHexGrid(29.82, 51.62);

            console.log(map_object);

            $.ajaxSetup({cache: false});
            var canvas = document.getElementById('mapcanvas'),
                ctx = canvas.getContext('2d');

            // создаем "туман войны"
            var revealedAreas = loadRevealedAreas();
            drawFogOfWar(ctx, revealedAreas);

            // отлавливаем координаты клика
            $("#mapcanvas").on('click', function(event){
                var coords = getCanvasXYPos(this, event);
                var hexcoords = getHex(coords.x, coords.y);
                alert(hexcoords.col + ':' + hexcoords.row);
            });



            $("#themap").on('click', function(event){
                var coords = getImageXYCoords(this, event);
                var hex_coords = getHex(coords.x, coords.y);
                hex_current_coords = hex_coords;

                var hex_status = checkHexContent(hex_coords);
                if (hex_status['result'] == 'ignore') return false;
                else {

                }

                switch (hex_status['result']) {
                    case 'ignore': {
                        return false;
                        break;
                    }
                    case 'empty': {
                        $("#colorboxed-view-content").html('По гексу '+ hex_coords.hexcoord +' информации нет! Но можно добавить: <button id="actor-edit"> Редактировать </button>');
                        $.colorbox({
                            inline: true,
                            href: '#colorboxed-view',
                            width: 800,
                            height: 600,
                            title: 'Информации нет!'
                        });
                        break;
                    }
                    case 'anydata': {
                        var str_title =
                                '&nbsp;<img src="images/cursor_drag_arrow_2.png" align="bottom" width="16" width="16">&nbsp;&nbsp;'
                                        + 'Координаты: </span>'
                                        + pad(hex_coords.col, 2) + pad(hex_coords.row, 2)
                                        + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                                        + '<button id="actor-edit"> Редактировать </button>';

                        $.colorbox({
                            href: 'core/action.get.content.php?'+$.param(hex_coords),
                            width: 800,
                            height: 600,
                            title: str_title
                        });

                        break;
                    }

                }

            }); // themap click

            $(document).on('click', '#actor-edit', function(){
                document.location.href = 'edit.php?frontend=imagemap&'+ $.param(hex_current_coords);
            });

            $("#colorbox").tinyDraggable({
                handle: '#cboxTitle',
                exclude: 'button'
            });
        });
    </script>
    <style type="text/css">
        .themap{position:absolute;z-index:1;}

        #container{
            display:inline-block;
            width:1048px;
            height:827px;
            margin: 0 auto;
            position:relative;
        }

        #mapcanvas{
            position:relative;
            z-index:20;
        }
        .themap {
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div id="container">
    <img class='themap' src="images/maps/trollfjorden_l.png" border="1"/>
    <canvas id="mapcanvas" width="1048" height="827"></canvas>
</div>
<br/>
Нажмите на <strike>кексик</strike> гексик карты и... =^.^=

<div style="display:none">
    <div id="colorboxed-view" style="padding:10px; background:#fff;">
        <div id="colorboxed-view-content"></div>
    </div>
</div>


</body>
</html>